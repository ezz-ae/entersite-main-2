rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function tenantFromToken() {
      return request.auth.token.tenantId;
    }

    function hasRole(allowedRoles) {
      return request.auth != null && (
        (request.auth.token.role != null && request.auth.token.role in allowedRoles) ||
        (request.auth.token.roles != null && request.auth.token.roles.hasAny(allowedRoles))
      );
    }

    function isTenantMember(tenantId) {
      return isSignedIn() && tenantId == tenantFromToken();
    }

    function isTenantAdmin(tenantId) {
      return isTenantMember(tenantId) && hasRole(['team_admin', 'agency_admin', 'super_admin']);
    }

    // Public inventory projects
    match /inventory_projects/{projectId} {
      allow read: if true;
      allow write: if false;
    }

    // Public published pages
    match /pages_public/{slug} {
      allow read: if true;
      allow write: if false;
    }

    // Tenant-scoped data
    match /tenants/{tenantId} {
      allow read: if isTenantMember(tenantId);
      allow create, update, delete: if isTenantAdmin(tenantId);

      match /settings/{docId} {
        allow read: if isTenantMember(tenantId);
        allow write: if isTenantAdmin(tenantId);
      }

      match /leads/{leadId} {
        allow read, create, update, delete: if isTenantMember(tenantId);
        match /notes/{noteId} {
          allow read, create, update, delete: if isTenantMember(tenantId);
        }
      }

      match /ads_campaigns/{docId} {
        allow read: if isTenantMember(tenantId);
        allow write: if isTenantAdmin(tenantId);
      }

      match /audience_requests/{docId} {
        allow read, write: if isTenantAdmin(tenantId);
      }

      match /marketing_plans/{docId} {
        allow read, write: if isTenantMember(tenantId);
      }

      match /teamInvites/{docId} {
        allow read, write: if isTenantAdmin(tenantId);
      }

      match /domain_requests/{docId} {
        allow read, write: if isTenantAdmin(tenantId);
      }

      match /events/{docId} {
        allow read, write: if isTenantMember(tenantId);
      }

      match /analytics/{docId} {
        allow read: if isTenantMember(tenantId);
        allow write: if isTenantAdmin(tenantId);
      }

      match /usage/{docId} {
        allow read: if isTenantMember(tenantId);
        allow write: if isTenantAdmin(tenantId);
      }

      match /billing_events/{docId} {
        allow read: if isTenantAdmin(tenantId);
        allow write: if isTenantAdmin(tenantId);
      }
    }

    match /subscriptions/{tenantId} {
      allow read: if isTenantMember(tenantId);
      allow write: if isTenantAdmin(tenantId);
    }

    // Sites are tenant-owned
    match /sites/{siteId} {
      allow create: if false; // Created via API
      allow read, update, delete: if isTenantMember(resource.data.tenantId);
    }

    // Contacts are tenant-owned
    match /contacts/{contactId} {
      allow create: if isSignedIn() && request.resource.data.tenantId == tenantFromToken();
      allow read, update, delete: if isTenantMember(resource.data.tenantId);
    }

    // Bot event logs are tenant-owned
    match /bot_events/{eventId} {
      allow create: if isSignedIn() && request.resource.data.tenantId == tenantFromToken();
      allow read, update, delete: if isTenantMember(resource.data.tenantId);
    }

    // Projects are tenant-owned
    match /projects/{projectId} {
      allow read, update, delete: if isTenantMember(resource.data.tenantId);
      allow create: if isSignedIn() && isTenantMember(request.resource.data.tenantId);
      match /pages/{pageId} {
        allow read, create, update, delete: if isTenantMember(get(/databases/$(database)/documents/projects/$(projectId)).data.tenantId);
      }
      match /audiences/{audId} {
        allow read, create, update, delete: if isTenantMember(get(/databases/$(database)/documents/projects/$(projectId)).data.tenantId);
      }
    }

    // Jobs are tenant-owned
    match /jobs/{jobId} {
      allow create: if isSignedIn() && isTenantMember(request.resource.data.tenantId);
      allow read, update, delete: if isTenantMember(resource.data.tenantId);
    }

    // Content posts are admin-only (server can still write)
    match /content_posts/{postId} {
      allow read, write: if false;
    }

    // Health checks are server-only
    match /health/{docId} {
      allow read, write: if false;
    }
  }
}
