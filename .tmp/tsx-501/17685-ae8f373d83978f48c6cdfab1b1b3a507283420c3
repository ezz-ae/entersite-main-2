{"code":"__filename=\"/Users/mahmoudezz/Downloads/v1_secure_ship/scripts/migrations/migrate-events-to-tenant.ts\";(()=>{\nvar __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf;var __hasOwnProp=Object.prototype.hasOwnProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});var __copyProps=(to,from,except,desc)=>{if(from&&typeof from===\"object\"||typeof from===\"function\"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,\"default\",{value:mod,enumerable:true}):target,mod));var import_config=require(\"dotenv/config\");var import_app=require(\"firebase-admin/app\");var import_firestore=require(\"firebase-admin/firestore\");var import_fs=__toESM(require(\"fs\"));var import_path=__toESM(require(\"path\"));function loadServiceAccount(){const explicitPath=process.env.GOOGLE_APPLICATION_CREDENTIALS;if(explicitPath){const filePath=import_path.default.resolve(process.cwd(),explicitPath);const raw=import_fs.default.readFileSync(filePath,\"utf-8\");const key=JSON.parse(raw);if(key?.type===\"service_account\"&&key?.project_id&&key?.private_key){console.log(`[migrate-events] Using GOOGLE_APPLICATION_CREDENTIALS: ${explicitPath}`);return{projectId:key.project_id,clientEmail:key.client_email,privateKey:key.private_key}}}try{const files=import_fs.default.readdirSync(process.cwd()).filter(file=>file.endsWith(\".json\"));for(const file of files){try{const filePath=import_path.default.resolve(process.cwd(),file);const raw=import_fs.default.readFileSync(filePath,\"utf-8\");const key=JSON.parse(raw);if(key?.type===\"service_account\"&&key?.project_id&&key?.private_key){console.log(`[migrate-events] Using service account file: ${file}`);return{projectId:key.project_id,clientEmail:key.client_email,privateKey:key.private_key}}}catch{}}}catch{}const projectId=process.env.FIREBASE_PROJECT_ID;const clientEmail=process.env.FIREBASE_CLIENT_EMAIL;const privateKey=process.env.FIREBASE_PRIVATE_KEY;if(projectId&&clientEmail&&privateKey){console.log(\"[migrate-events] Using FIREBASE_* env credentials.\");return{projectId,clientEmail,privateKey:privateKey.replace(/\\\\n/g,\"\\n\")}}throw new Error(\"Service account credentials not found for migration.\")}__name(loadServiceAccount,\"loadServiceAccount\");const app=(0,import_app.initializeApp)({credential:(0,import_app.cert)(loadServiceAccount())});const db=(0,import_firestore.getFirestore)(app);const PAGE_SIZE=Number(process.env.PAGE_SIZE||\"200\");const MAX_PAGES=Number(process.env.MAX_PAGES||\"0\");const DRY_RUN=process.env.DRY_RUN===\"true\";const DELETE_SOURCE=process.env.DELETE_SOURCE===\"true\";async function migrateEvents(){console.log(\"[migrate-events] Starting migration\");console.log(`[migrate-events] PAGE_SIZE=${PAGE_SIZE} DRY_RUN=${DRY_RUN} DELETE_SOURCE=${DELETE_SOURCE}`);let lastDoc=null;let page=0;let scanned=0;let copied=0;let skippedMissingTenant=0;let deleted=0;while(true){let query=db.collection(\"events\").orderBy(\"__name__\").limit(PAGE_SIZE);if(lastDoc){query=query.startAfter(lastDoc)}const snapshot=await query.get();if(snapshot.empty)break;page+=1;let batchOps=0;const batch=db.batch();for(const doc of snapshot.docs){scanned+=1;const data=doc.data();const tenantId=typeof data.tenantId===\"string\"?data.tenantId.trim():\"\";if(!tenantId){skippedMissingTenant+=1;continue}const destRef=db.collection(\"tenants\").doc(tenantId).collection(\"events\").doc(doc.id);if(!DRY_RUN){batch.set(destRef,{...data,tenantId},{merge:true});batchOps+=1;if(DELETE_SOURCE){batch.delete(doc.ref);batchOps+=1;deleted+=1}}copied+=1}if(!DRY_RUN&&batchOps>0){await batch.commit()}lastDoc=snapshot.docs[snapshot.docs.length-1]||null;console.log(`[migrate-events] page=${page} scanned=${scanned} copied=${copied} skippedMissingTenant=${skippedMissingTenant}`);if(MAX_PAGES>0&&page>=MAX_PAGES){console.log(\"[migrate-events] MAX_PAGES reached, stopping early.\");break}}console.log(\"[migrate-events] Completed\");console.log(`[migrate-events] scanned=${scanned}`);console.log(`[migrate-events] copied=${copied}`);console.log(`[migrate-events] skippedMissingTenant=${skippedMissingTenant}`);console.log(`[migrate-events] deleted=${deleted}`)}__name(migrateEvents,\"migrateEvents\");if(require.main===module){migrateEvents().catch(err=>{console.error(\"[migrate-events] failed\",err);process.exit(1)})}\n})()\n","warnings":[],"map":{"version":3,"mappings":"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","names":["path","fs"],"ignoreList":[],"sources":["/Users/mahmoudezz/Downloads/v1_secure_ship/scripts/migrations/migrate-events-to-tenant.ts"],"sourcesContent":[null]}}